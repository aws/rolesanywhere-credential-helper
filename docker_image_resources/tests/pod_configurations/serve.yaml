apiVersion: v1
kind: Pod
metadata:
  name: serve-test
spec:
  containers:
  - name: credential-helper
    image: $REGISTRY/$IMAGE_NAME:$VERSION
    imagePullPolicy: Never #Required when using a local image
    resources:
      requests:
        memory: "128Mi"
        cpu: "100m"
      limits:
        memory: "256Mi"
        cpu: "200m"
    args:
    - "serve"
    - "--certificate"
    - "/certs/certificate.pem"
    - "--private-key"
    - "/certs/private_key.pem"
    - "--trust-anchor-arn"
    - "$TRUST_ANCHOR_ARN"
    - "--profile-arn"
    - "$PROFILE_ARN"
    - "--role-arn"
    - "$ROLE_ARN"
    - "--debug"
    volumeMounts:
    - name: certs-volume
      mountPath: /certs
      readOnly: true

  - name: test-client
    image: amazon/aws-cli:latest
    resources:
      requests:
        memory: "64Mi"
        cpu: "50m"
      limits:
        memory: "128Mi"
        cpu: "100m"
    env:
    - name: AWS_EC2_METADATA_SERVICE_ENDPOINT
      value: "http://127.0.0.1:9911/"
    - name: ROLE_ARN
      value: "$ROLE_ARN"

    command: 
    - "/bin/bash"
    - "-c"
    - |
      echo "Executing auth validation script..."
      # Execute the script
      /resources/evaluate-caller-identity.sh
    volumeMounts:
    - name: test-volume
      mountPath: /resources

  volumes:
  - name: certs-volume
    configMap:
      name: cert-files
  - name: test-volume
    configMap:
      name: test-resources
      defaultMode: 0755 #Ensure client test script is executable